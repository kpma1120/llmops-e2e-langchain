name: CI/CD Deployment to Cloud Run

on:
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.*"
      - name: Install Ruff
        run: pip install ruff
      - name: Run Ruff Linter
        run: ruff check .

  test:
    runs-on: ubuntu-latest
    needs: lint
    env:
      VECTORSTORE_PROVIDER: ${{ secrets.VECTORSTORE_PROVIDER }}
      PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
      PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
      CHROMA_PERSIST_DIR: ${{ secrets.CHROMA_PERSIST_DIR }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.*"
      - name: Install test dependencies
        run: pip install -r requirements-test.txt
      - name: Run tests
        run: pytest
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results

  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: google/cloud-sdk:latest
    needs: [lint, test]
    env:
      IMAGE: "us-east1-docker.pkg.dev/genai-llmops-repo1/my-repo/llm-app"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Install Docker CLI
        run: |
          apt-get update
          apt-get install -y docker.io

      - name: Build and Push Image
        run: |
          docker build -t $IMAGE:$GITHUB_SHA -t $IMAGE:latest -f Dockerfile .
          docker push $IMAGE:$GITHUB_SHA
          docker push $IMAGE:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy llm-app \
            --image $IMAGE:$GITHUB_SHA \
            --region us-east1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars VECTORSTORE_PROVIDER=${{ secrets.VECTORSTORE_PROVIDER }} \
            --set-env-vars PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }} \
            --set-env-vars PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }} \
            --set-env-vars CHROMA_PERSIST_DIR=${{ secrets.CHROMA_PERSIST_DIR }}
